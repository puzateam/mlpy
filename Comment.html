<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฝากข้อความถึงเรา</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Emoji Picker Element (Web Component) CDN -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #FFF0F5;
        }
        .btn-gradient {
            background-image: linear-gradient(to right, #FFC0CB 0%, #FFB6C1 50%, #FFC0CB 100%);
            color: #8B4513;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-gradient:hover {
            background-image: linear-gradient(to right, #FFB6C1 0%, #FFC0CB 50%, #FFB6C1 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .btn-gradient:disabled {
            background-image: linear-gradient(to right, #FFE4E1 0%, #FFF0F5 100%);
            color: #A0522D;
            cursor: not-allowed;
            box-shadow: none;
        }
        .comment-card {
            background-color: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(255, 105, 180, 0.1);
            border: 1px solid #FFD1DC;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .comment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(255, 105, 180, 0.15);
        }
        .comment-card .comment-name { color: #FF69B4; font-weight: 600; }
        .comment-card .comment-text { color: #774f38; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }
        .comment-card .comment-date { color: #FFB6C1; }
        .modal { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }
        .modal-content { background-color: #FFF9FB; border-radius: 1.5rem; box-shadow: 0 15px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-title { color: #DB7093; }
        .emoji-toggle-button { background-color: #FFE4E1; color: #CD5C5C; border-radius: 9999px; transition: background-color 0.2s ease; }
        .emoji-toggle-button:hover { background-color: #FFC0CB; }
        emoji-picker { width: 100%; height: 220px; --emoji-size: 1.3rem; --num-columns: 9; border: 1px solid #FFD1DC; border-radius: 0.75rem; }
        .no-comments-container { border: 2px dashed #FFB6C1; background-color: rgba(255, 240, 245, 0.5); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start pt-12 pb-8 px-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-3xl md:text-4xl font-bold" style="color: #FF69B4;">ฝากข้อความถึงเรา <i class="fas fa-heartbeat text-pink-400"></i></h1>
            <p class="text-gray-500 mt-2 text-lg">แบ่งปันความรู้สึกดีๆ หรือคำแนะนำติชมได้เลยน้าา~</p>
        </header>

        <section id="comments-display-section" class="mb-12">
            <div id="comments-list" class="space-y-6">
                <!-- Comments will be loaded here by JavaScript -->
            </div>
        </section>

        <!-- Container for the "Add Comment" button -->
        <div id="add-comment-button-container" class="text-center mt-10 mb-10">
            <!-- Button will be added here by JavaScript -->
        </div>
    </div>

    <div id="commentModal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content w-full max-w-lg p-6 md:p-8 m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="modal-title text-2xl font-semibold">เขียนข้อความใหม่ <i class="fas fa-pencil-alt ml-2"></i></h2>
                <button id="closeModalButton" class="text-gray-500 hover:text-red-500 text-2xl">×</button>
            </div>
            <form id="comment-form">
                <div class="mb-4">
                    <label for="modalUserName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อเล่น / นามแฝง <span class="text-red-500">*</span></label>
                    <input type="text" id="modalUserName" name="userName" class="mt-1 p-3 w-full border border-gray-300 rounded-lg shadow-sm focus:ring-pink-400 focus:border-pink-400 transition-colors" placeholder="เช่น น้องชมพู" required>
                </div>
                <div class="mb-4">
                    <label for="modalCommentMessage" class="block text-sm font-medium text-gray-700 mb-1">ข้อความของคุณ <span class="text-red-500">*</span></label>
                    <textarea id="modalCommentMessage" name="commentMessage" rows="4" class="mt-1 p-3 w-full border border-gray-300 rounded-lg shadow-sm focus:ring-pink-400 focus:border-pink-400 transition-colors" placeholder="พิมพ์ความในใจ..." required></textarea>
                </div>
                <div class="mb-6">
                    <button type="button" id="emojiToggleButton" class="emoji-toggle-button px-4 py-2 text-sm font-medium flex items-center">
                        <i class="far fa-smile mr-2"></i>เลือก Emoji
                    </button>
                    <div id="emojiPickerContainer" class="mt-3 hidden">
                        <emoji-picker locale="th" class="light"></emoji-picker>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelModalButton" class="py-2 px-5 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors font-medium">ยกเลิก</button>
                    <button type="submit" id="submit-comment-button" class="btn-gradient py-2.5 px-6 text-base font-semibold rounded-full">
                        ส่งข้อความ <i class="fas fa-paper-plane ml-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>© <span id="currentYear"></span> โรงเรียนชุมชนบ้านแม่หละป่าป๋วย. All rights reserved.</p>
    </footer>

<script>
    // URL ของ Google Apps Script Web App (ต้องเปลี่ยนเป็น URL จริงของพี่ ที่ได้จากการ Deploy ใหม่)
    const COMMENTS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxWvVANjIsOlsoP8nj81X1kcamdMQSPKOys9C0hiB4yaw7W-EBwkG3RYws83VAspliz/exec";

    const commentsListDiv = document.getElementById('comments-list');
    const addCommentButtonContainer = document.getElementById('add-comment-button-container');

    // Modal elements
    const commentModal = document.getElementById('commentModal');
    const closeModalButton = document.getElementById('closeModalButton');
    const cancelModalButton = document.getElementById('cancelModalButton');
    const commentForm = document.getElementById('comment-form');
    const modalUserNameInput = document.getElementById('modalUserName');
    const modalCommentMessageTextarea = document.getElementById('modalCommentMessage');
    const submitCommentButton = document.getElementById('submit-comment-button');
    const emojiToggleButton = document.getElementById('emojiToggleButton');
    const emojiPickerContainer = document.getElementById('emojiPickerContainer');
    const emojiPicker = emojiPickerContainer.querySelector('emoji-picker');

    function openCommentModal() {
        commentModal.classList.remove('hidden');
        setTimeout(() => commentModal.classList.remove('opacity-0'), 10); // For transition
        modalUserNameInput.value = ''; // Clear previous input
        modalCommentMessageTextarea.value = '';
        emojiPickerContainer.classList.add('hidden'); // Hide emoji picker initially
    }

    function closeCommentModal() {
        commentModal.classList.add('opacity-0');
        setTimeout(() => commentModal.classList.add('hidden'), 300); // Wait for transition
    }

    // --- ฟังก์ชันโหลดความคิดเห็น ---
    async function loadComments() {
        if (!commentsListDiv) return;
        commentsListDiv.innerHTML = '<p class="text-center text-gray-400 animate-pulse py-8 text-lg">กำลังโหลดข้อความน่ารักๆ...</p>';
        addCommentButtonContainer.innerHTML = ''; // Clear previous button

        if (COMMENTS_WEB_APP_URL === "YOUR_NEW_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE_FOR_COMMENTS" || !COMMENTS_WEB_APP_URL) {
            commentsListDiv.innerHTML = `
                <div class="no-comments-container text-center p-8 md:p-12 rounded-2xl">
                    <i class="fas fa-cogs fa-3x text-yellow-500 mb-4"></i>
                    <p class="text-xl text-gray-600 mb-4">ยังไม่ได้ตั้งค่า URL ของ Web App</p>
                    <p class="text-sm text-gray-500">กรุณาอัปเดตค่า <code>COMMENTS_WEB_APP_URL</code> ในไฟล์ comment.html ด้วย URL ที่ได้จากการ Deploy Google Apps Script นะคะ</p>
                </div>`;
            return;
        }

        try {
            // Use a timestamp to prevent caching issues with GET requests
            const response = await fetch(`${COMMENTS_WEB_APP_URL}?action=getPublicComments&cb=${new Date().getTime()}`);
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`API call failed: ${response.status} ${response.statusText}. Response: ${errorText}`);
            }
            const result = await response.json();

            if (result.error) {
                commentsListDiv.innerHTML = `<p class="text-center text-red-500 py-4">เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${result.error} ${result.details || ''}</p>`;
                return;
            }

            if (result.data && result.data.length > 0) {
                let html = '';
                result.data.forEach(comment => {
                    const formattedDate = comment.timestamp ? new Date(comment.timestamp).toLocaleString('th-TH', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'ไม่ระบุเวลา';
                    const safeName = (comment.name || 'ผู้ไม่ประสงค์ออกนาม').replace(/</g, "<").replace(/>/g, ">");
                    const safeCommentText = (comment.commentText || '').replace(/</g, "<").replace(/>/g, ">").replace(/\n/g, "<br>");

                    html += `
                        <div class="comment-card p-5 md:p-6" data-comment-id="${comment.id || ''}">
                            <div class="flex justify-between items-start mb-2">
                                <p class="comment-name text-lg">${safeName}</p>
                                <p class="comment-date text-xs pt-1">${formattedDate} น.</p>
                            </div>
                            <p class="comment-text">${safeCommentText}</p>
                        </div>
                    `;
                });
                commentsListDiv.innerHTML = html;

                addCommentButtonContainer.innerHTML = `
                    <button id="openModalMainButton" class="btn-gradient py-3 px-8 text-lg font-semibold rounded-full">
                        <i class="fas fa-plus-circle mr-2"></i>ฝากข้อความเพิ่ม
                    </button>`;
                document.getElementById('openModalMainButton').addEventListener('click', openCommentModal);

            } else {
                commentsListDiv.innerHTML = `
                    <div class="no-comments-container text-center p-8 md:p-12 rounded-2xl">
                        <i class="far fa-comment-dots fa-4x text-pink-300 mb-6"></i>
                        <p class="text-xl text-gray-500 mb-6">ยังไม่มีข้อความในขณะนี้...</p>
                    </div>`; // Removed button from here, will be added to addCommentButtonContainer
                addCommentButtonContainer.innerHTML = `
                    <button id="openModalFromEmptyStateButton" class="btn-gradient py-3 px-8 text-lg font-semibold rounded-full">
                        <i class="fas fa-pen-nib mr-2"></i>มาเป็นคนแรกที่ส่งข้อความถึงเรากันเถอะ!
                    </button>`;
                const openModalBtn = document.getElementById('openModalFromEmptyStateButton');
                if (openModalBtn) openModalBtn.addEventListener('click', openCommentModal);
            }
        } catch (error) {
            console.error("Load comments error:", error);
            commentsListDiv.innerHTML = `<p class="text-center text-red-500 py-4">การเชื่อมต่อเพื่อโหลดความคิดเห็นล้มเหลว: ${error.message}</p>`;
        }
    }

    // --- ฟังก์ชันส่งความคิดเห็น ---
    async function handleSubmitComment(event) {
        event.preventDefault();
        const name = modalUserNameInput.value.trim();
        const text = modalCommentMessageTextarea.value.trim();

        if (!name) {
            Swal.fire({icon: 'warning', title: 'อุ๊ปส์!', text: 'กรุณากรอกชื่อเล่นหรือนามแฝงด้วยน้า', confirmButtonColor: '#FF69B4'});
            modalUserNameInput.focus(); return;
        }
        if (!text) {
            Swal.fire({icon: 'warning', title: 'เอ๊ะ!', text: 'เหมือนจะลืมพิมพ์ข้อความหรือเปล่าคะ?', confirmButtonColor: '#FF69B4'});
            modalCommentMessageTextarea.focus(); return;
        }
        if (COMMENTS_WEB_APP_URL === "YOUR_NEW_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE_FOR_COMMENTS" || !COMMENTS_WEB_APP_URL) {
             Swal.fire({icon: 'error', title: 'ยังไม่ได้ตั้งค่า!', text: 'กรุณาตั้งค่า URL ของ Web App ใน comment.html ก่อนส่งข้อความค่ะ', confirmButtonColor: '#FF69B4'});
             return;
        }

        submitCommentButton.disabled = true;
        submitCommentButton.innerHTML = `<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2" role="status"></span>กำลังส่งข้อความ...`;

        try {
            const payload = {
                action: "submitComment",
                name: name,
                commentText: text
                // parentId: null // สามารถเพิ่มได้ถ้ามีการทำระบบ reply
            };
            const response = await fetch(COMMENTS_WEB_APP_URL, {
                method: 'POST',
                mode: 'cors', // CORS is usually handled by Apps Script if deployed for 'Anyone'
                cache: 'no-cache',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Apps Script doPost often expects text/plain for e.postData.contents
                body: JSON.stringify(payload)
            });

            const resultText = await response.text(); // Get raw text first
            let result;
            try {
                result = JSON.parse(resultText);
            } catch (parseError) {
                console.error("Error parsing JSON response from submitComment:", resultText, parseError);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถประมวลผลการตอบกลับจากเซิร์ฟเวอร์ได้ (รูปแบบไม่ถูกต้อง)', 'error');
                // It's possible Apps Script returned plain text error, show it if resultText is short
                if (resultText && resultText.length < 200 && !resultText.toLowerCase().includes("html")) {
                     Swal.fire('เกิดข้อผิดพลาด', `เซิร์ฟเวอร์ตอบกลับ: ${resultText}`, 'error');
                }
                return;
            }

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'ส่งข้อความเรียบร้อย!',
                    text: result.message, // "ได้รับข้อมูลแล้ว กำลังรอผู้ดูแลระบบอนุมัติค่ะ"
                    confirmButtonColor: '#FF69B4',
                    timer: 5000,
                    timerProgressBar: true
                });
                closeCommentModal();
                commentForm.reset();
                // Consider not auto-reloading unless you implement real-time or admin approves quickly.
                // loadComments(); // Reload comments
            } else {
                Swal.fire('เกิดข้อผิดพลาด', result.message || 'ไม่สามารถส่งความคิดเห็นได้', 'error');
            }
        } catch (error) {
            console.error("Submit comment error:", error);
            Swal.fire('เกิดข้อผิดพลาดในการเชื่อมต่อ', `ไม่สามารถติดต่อเซิร์ฟเวอร์ได้: ${error.message}`, 'error');
        } finally {
            submitCommentButton.disabled = false;
            submitCommentButton.innerHTML = 'ส่งข้อความ <i class="fas fa-paper-plane ml-2"></i>';
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        closeModalButton.addEventListener('click', closeCommentModal);
        cancelModalButton.addEventListener('click', closeCommentModal);
        commentModal.addEventListener('click', (event) => {
            if (event.target === commentModal) closeCommentModal();
        });
        if (commentForm) commentForm.addEventListener('submit', handleSubmitComment);
        if (emojiToggleButton && emojiPickerContainer && emojiPicker && modalCommentMessageTextarea) {
            emojiToggleButton.addEventListener('click', () => emojiPickerContainer.classList.toggle('hidden'));
            emojiPicker.addEventListener('emoji-click', event => {
                const emoji = event.detail.unicode;
                const textarea = modalCommentMessageTextarea;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + emoji + text.substring(end);
                textarea.focus();
                textarea.selectionEnd = start + emoji.length;
            });
        }
        const currentYearSpan = document.getElementById('currentYear');
        if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear() + 543;

        loadComments(); // โหลดความคิดเห็นเมื่อหน้าเว็บพร้อม
    });
</script>
</body>
</html>
